
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hierarchical Cytoscape.js Example with Matn Nodes</title>
  <script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>
  <script src="https://unpkg.com/dagre/dist/dagre.min.js"></script>
  <script src="https://unpkg.com/cytoscape-dagre/cytoscape-dagre.js"></script>
  <style>
    #cy {
      width: 100%;
      height: 100vh;
      background-color: #f9f9f9;
    }

    /* Matn style is defined as a special class */
    .matn-box {
      background-color: #f0f0f0;
      border: 1px solid #ddd;
      padding: 6px;
      border-radius: 3px;
      font-size: 14px;
      font-family: Arial, sans-serif;
      direction: rtl;  /* For Arabic text */
      text-align: right;
    }
  </style>
</head>
<body>
  <div id="cy"></div>

  <script>
    // Define colors based on geography
    const geographyColors = {"Madinah": "#A0D2DB", "Makkah": "#FFB7C5", "Basra": "#F5CBA7", "Baghdad": "#C5E3BF", "Unknown": "#D3D3D3"};

    // Function to generate a slightly darker border color
    function darkerColor(color) {
      const darkerHex = (hex) => Math.max(0, hex - 40).toString(16).padStart(2, '0');  // Darken by 40 (hex)
      const r = darkerHex(parseInt(color.slice(1, 3), 16));
      const g = darkerHex(parseInt(color.slice(3, 5), 16));
      const b = darkerHex(parseInt(color.slice(5, 7), 16));
        
      const darkColor = `#${r}${g}${b}`;  // Format correctly as a hex color
      
      return darkColor;
    }

    const cy = cytoscape({
      container: document.getElementById('cy'),  // container to render in
      elements: [{"data": {"id": "n0", "label": "أحمد بن حنبل", "geography": "Baghdad"}}, {"data": {"id": "n1", "label": "سليمان بن داود", "geography": "Baghdad"}}, {"data": {"id": "n2", "label": "عبد الصمد بن عبد الوارث", "geography": "Basra"}}, {"data": {"id": "n3", "label": "شعبة ابن الحجاج بن الورد", "geography": "Basra"}}, {"data": {"id": "n4", "label": "همام بن يحيى", "geography": "Basra"}}, {"data": {"id": "n5", "label": "قتادة بن دعامة", "geography": "Basra"}}, {"data": {"id": "n6", "label": "زرارة بن أوفى العامري", "geography": "Basra"}}, {"data": {"id": "n7", "label": "أبو هريرة", "geography": "Madinah"}}, {"data": {"id": "n8", "label": "عبد الصمد بن عبد الوارث", "geography": "Basra"}}, {"data": {"id": "n9", "label": "رسول الله", "geography": "Madinah"}}, {"data": {"id": "matn", "label": "إذا باتت المرأة هاجرة لفراش زوجها\nلعنتها الملائكة\nحتى تصبح  )أو: حتى ترجع(", "isMatn": true}}, {"data": {"source": "n1", "target": "n0"}}, {"data": {"source": "n2", "target": "n0"}}, {"data": {"source": "n3", "target": "n1"}}, {"data": {"source": "n3", "target": "n2"}}, {"data": {"source": "n4", "target": "n1"}}, {"data": {"source": "n4", "target": "n2"}}, {"data": {"source": "n5", "target": "n3"}}, {"data": {"source": "n5", "target": "n4"}}, {"data": {"source": "n6", "target": "n5"}}, {"data": {"source": "n7", "target": "n6"}}, {"data": {"source": "n8", "target": "n7"}}, {"data": {"source": "n9", "target": "n8"}}, {"data": {"source": "n0", "target": "matn"}}],

      layout: {
        name: 'dagre',  // Hierarchical layout (Dagre)
        rankDir: 'TB',  // Top-to-bottom direction
        nodeSep: 50,  // Space between nodes
        edgeSep: 10,  // Space between edges
        rankSep: 100  // Space between levels
      },

      style: [
        {
          selector: 'node',
          style: {
            'label': 'data(label)',
            'text-valign': 'center',
            'text-halign': 'center',
            'background-color': (ele) => geographyColors[ele.data('geography')] || '#D3D3D3',  // Assign color based on geography
            'border-color': function(ele) { 
              const geographyColor = geographyColors[ele.data('geography')] || '#D3D3D3';
              return darkerColor(geographyColor);  // Apply the darker color
            },
            'border-width': 2,
            'shape': 'rectangle',
            'width': '150px',
            'height': '40px',
            'font-family': 'Arial, sans-serif',  // Ensure text looks good for Arabic
            'font-size': '14px',
            'direction': 'rtl',  // Right-to-left direction for Arabic text
            'text-align': 'right'
          }
        },
        {
          selector: 'node[isMatn]',  // Style for matn nodes
          style: {
            'label': 'data(label)',
            'background-color': '#f0f0f0',  // Light gray background for matn
            'border-color': '#ddd',
            'border-width': 2,
            'shape': 'rectangle',
            'width': '150px',  // Match width to parent node
            'height': function(ele) {
              const textLength = ele.data('label').length;
              const estimatedLines = Math.ceil(textLength / 30);  // Estimate lines based on 30 chars per line
              const baseHeight = 20;  // Base height for a single line
              const buffer = 1.2;  // 20% buffer for additional space
              return (baseHeight * estimatedLines * buffer) + 'px';  // Calculate dynamic height
            },
            'font-family': 'Arial, sans-serif',
            'font-size': '14px',
            'direction': 'rtl',  // Right-to-left for Arabic text
            'text-halign': 'center',  // Ensure text is aligned to the right within the box
            'text-valign': 'center',  // Vertical alignment (adjust if you need something else)
            'text-wrap': 'wrap',  // Enable text wrapping
            'text-max-width': '150px',  // Match node width
            'padding': '5px'  // Padding for better readability
          }

        },
        {
          selector: 'edge',
          style: {
            'width': 2,
            'line-color': '#ccc',
            'target-arrow-color': '#ccc',
            'target-arrow-shape': 'triangle'
          }
        }
      ],

      userZoomingEnabled: true,  // Re-enable zooming
      userPanningEnabled: true,  // Re-enable panning
      boxSelectionEnabled: false,  // Disable selection box
      autounselectify: true  // Disable node selection
    });

    // Apply the layout and lock the nodes in place
    cy.layout({
      name: 'dagre',
      rankDir: 'TB',
      nodeSep: 30,
      edgeSep: 10,
      rankSep: 100
    }).run();

    // Lock the nodes after the layout
    cy.nodes().forEach(node => {
      node.lock();  // Lock all nodes to prevent moving
    });
  </script>
</body>
</html>
    